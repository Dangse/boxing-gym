
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì²´ìœ¡ê´€ ê¸‰ì—¬ê´€ë¦¬ Pro (ì¸ì ì‚¬í•­ í¬í•¨)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="tel"], input[type="text"] { -moz-appearance: textfield; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .modal-bg { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="text-slate-800 pb-20">

    <div class="max-w-3xl mx-auto px-4 py-4">
        
        <header class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 mb-5 sticky top-2 z-40">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-black text-slate-800 flex items-center gap-2">
                    ğŸ¥Š ê¸‰ì—¬ ì¥ë¶€
                </h1>
                <select id="yearSelect" onchange="changeYear()" class="bg-slate-100 font-bold text-indigo-700 py-1 px-3 rounded-lg border-none outline-none focus:ring-2 focus:ring-indigo-500">
                    </select>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="openMasterManager()" class="bg-indigo-50 text-indigo-700 border border-indigo-200 py-3 rounded-xl font-bold text-sm hover:bg-indigo-100 flex items-center justify-center gap-2 transition-all active:scale-95">
                    <span>ğŸ‘¥</span> ì½”ì¹˜ ëª…ë‹¨ ê´€ë¦¬
                </button>
                <button onclick="sendEmailReport()" class="bg-slate-800 text-white py-3 rounded-xl font-bold text-sm hover:bg-slate-900 flex items-center justify-center gap-2 transition-all active:scale-95 shadow-md">
                    <span>ğŸ“§</span> ì„¸ë¬´ì‚¬ ì „ì†¡
                </button>
            </div>
            <div id="saveIndicator" class="text-right text-[10px] text-slate-400 mt-2 h-4 font-medium"></div>
        </header>

        <div class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-2xl p-5 text-white shadow-lg mb-6">
            <div class="flex justify-between items-start mb-2">
                <h2 class="text-sm font-bold text-indigo-100 opacity-80">ì˜¬í•´ ëˆ„ì  ì§€ê¸‰ í˜„í™©</h2>
                <span class="bg-white/20 px-2 py-0.5 rounded text-[10px]">Total Year</span>
            </div>
            <div class="flex justify-between items-end">
                <div>
                    <p class="text-xs text-indigo-200 mb-1">ì´ ì‹¤ì§€ê¸‰ì•¡ (ì„¸í›„)</p>
                    <p id="dashNet" class="text-3xl font-black tracking-tight">0ì›</p>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-indigo-200">ì´ ì„¸ì „ <span id="dashGross" class="text-white font-bold ml-1 text-sm">0</span></div>
                    <div class="text-[10px] text-indigo-200">ì´ ì„¸ê¸ˆ <span id="dashTax" class="text-red-200 font-bold ml-1 text-sm">0</span></div>
                </div>
            </div>
        </div>

        <div id="monthContainer" class="space-y-6">
            </div>

        <div class="text-center text-slate-300 text-xs mt-10 mb-4">
            Boxing Gym Payroll System Final
        </div>
    </div>

    <div id="masterModal" class="fixed inset-0 modal-bg z-[60] hidden flex items-center justify-center px-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl animate-[fadeIn_0.2s_ease-out] flex flex-col max-h-[80vh]">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-slate-800">ì½”ì¹˜ ì¸ì ì‚¬í•­ ê´€ë¦¬</h3>
                <button onclick="closeMasterModal()" class="text-slate-400 hover:text-slate-600">âœ•</button>
            </div>
            
            <div class="p-5 overflow-y-auto flex-1 custom-scroll">
                <div class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100 mb-6">
                    <h4 class="text-xs font-bold text-indigo-800 mb-3">âœ¨ ì‹ ê·œ ì½”ì¹˜ ë“±ë¡</h4>
                    <div class="space-y-2">
                        <input type="text" id="newCoachName" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)" class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        <input type="text" id="newCoachJumin" placeholder="ì£¼ë¯¼ë²ˆí˜¸ (ì˜ˆ: 900101-1******)" class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        <button onclick="addNewCoachToMaster()" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg text-sm hover:bg-indigo-700 mt-2">ë“±ë¡í•˜ê¸°</button>
                    </div>
                </div>

                <h4 class="text-xs font-bold text-slate-500 mb-3 ml-1">ë“±ë¡ëœ ì½”ì¹˜ ëª…ë‹¨</h4>
                <div id="masterCoachList" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>

    <div id="rosterModal" class="fixed inset-0 modal-bg z-[60] hidden flex items-center justify-center px-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-[fadeIn_0.2s_ease-out]">
            <h3 class="text-lg font-bold mb-4" id="rosterModalTitle">ê·¼ë¬´ì ì¶”ê°€</h3>
            <p class="text-xs text-slate-500 mb-4">ì´ë‹¬ ê¸‰ì—¬ ëŒ€ì¥ì— í¬í•¨í•  ì½”ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
            <div id="rosterList" class="space-y-2 max-h-60 overflow-y-auto mb-4">
                </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeRosterModal()" class="px-4 py-2 text-slate-500 font-medium hover:bg-slate-100 rounded-lg">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // === 1. ë°ì´í„° êµ¬ì¡° ===
        const CURRENT_YEAR = new Date().getFullYear().toString();
        let db = {
            coaches: [], // [{ id, name, jumin }] -> ì£¼ë¯¼ë²ˆí˜¸ í•„ë“œ ì¶”ê°€
            years: {},   // {"2026": {"c1": [12ê°œì›”]}}
            rosters: {}  // {"2026-0": ["c1"]}
        };

        window.onload = function() {
            loadData();
            setupYearSelect();
            renderAll();
        };

        function loadData() {
            const saved = localStorage.getItem('boxing_payroll_v6_final');
            if (saved) {
                db = JSON.parse(saved);
            }
            if (!db.years[CURRENT_YEAR]) db.years[CURRENT_YEAR] = {};
            if (!db.rosters) db.rosters = {};
        }

        function saveData() {
            localStorage.setItem('boxing_payroll_v6_final', JSON.stringify(db));
            const ind = document.getElementById('saveIndicator');
            ind.innerText = "â— ì•ˆì „í•˜ê²Œ ì €ì¥ë¨";
            ind.classList.add('text-green-600');
            setTimeout(() => {
                ind.innerText = "";
                ind.classList.remove('text-green-600');
            }, 2000);
        }

        // === 2. [ëª¨ë‹¬ 1] ë§ˆìŠ¤í„° ì½”ì¹˜ ê´€ë¦¬ (ì¸ì ì‚¬í•­) ===
        function openMasterManager() {
            renderMasterCoachList();
            document.getElementById('newCoachName').value = '';
            document.getElementById('newCoachJumin').value = '';
            document.getElementById('masterModal').classList.remove('hidden');
        }

        function closeMasterModal() {
            document.getElementById('masterModal').classList.add('hidden');
        }

        function renderMasterCoachList() {
            const listEl = document.getElementById('masterCoachList');
            if (db.coaches.length === 0) {
                listEl.innerHTML = '<p class="text-center text-slate-400 text-xs py-4">ë“±ë¡ëœ ì½”ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            listEl.innerHTML = db.coaches.map(c => `
                <div class="bg-white border border-slate-200 rounded-xl p-3 shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-bold text-slate-800">${c.name}</div>
                            <div class="text-xs text-slate-400 mt-0.5">ì£¼ë¯¼ë²ˆí˜¸: ${c.jumin || '-'}</div>
                        </div>
                        <button onclick="deleteMasterCoach('${c.id}')" class="text-xs text-red-400 hover:text-red-600 border border-slate-200 px-2 py-1 rounded">ì‚­ì œ</button>
                    </div>
                    <div class="mt-2 flex gap-2">
                        <input type="text" value="${c.jumin || ''}" 
                            placeholder="ì£¼ë¯¼ë²ˆí˜¸ ìˆ˜ì •"
                            id="edit-jumin-${c.id}"
                            class="flex-1 bg-slate-50 border border-slate-100 rounded px-2 py-1 text-xs outline-none focus:ring-1 focus:ring-indigo-300">
                        <button onclick="updateCoachJumin('${c.id}')" class="bg-slate-800 text-white text-xs px-3 py-1 rounded">ìˆ˜ì •</button>
                    </div>
                </div>
            `).join('');
        }

        function addNewCoachToMaster() {
            const nameInput = document.getElementById('newCoachName');
            const juminInput = document.getElementById('newCoachJumin');
            const name = nameInput.value.trim();
            const jumin = juminInput.value.trim();

            if (!name) {
                alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (db.coaches.length >= 20) {
                alert("ì½”ì¹˜ ë“±ë¡ì€ ìµœëŒ€ 20ëª…ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }

            const newId = 'c_' + Date.now();
            db.coaches.push({ id: newId, name: name, jumin: jumin });
            
            // í¸ì˜ìƒ í˜„ì¬ ë…„ë„ ëª¨ë“  ë‹¬ì˜ Rosterì— ìë™ ë“±ë¡ (ê¸‰ì—¬ ì…ë ¥ í¸í•˜ê²Œ)
            const year = document.getElementById('yearSelect').value;
            for(let m=0; m<12; m++) {
                if(!db.years[year]) db.years[year] = {};
                if(!db.years[year][newId]) db.years[year][newId] = Array(12).fill(0);
                
                const rKey = `${year}-${m}`;
                if(!db.rosters[rKey]) db.rosters[rKey] = [];
                if(!db.rosters[rKey].includes(newId)) db.rosters[rKey].push(newId);
            }

            saveData();
            renderMasterCoachList();
            renderAll(); // ë©”ì¸ í™”ë©´ë„ ê°±ì‹ 
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            nameInput.value = '';
            juminInput.value = '';
            nameInput.focus();
        }

        function updateCoachJumin(id) {
            const newVal = document.getElementById(`edit-jumin-${id}`).value;
            const coach = db.coaches.find(c => c.id === id);
            if(coach) {
                coach.jumin = newVal;
                saveData();
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }

        function deleteMasterCoach(id) {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì½”ì¹˜ì˜ ëª¨ë“  ê¸‰ì—¬ ê¸°ë¡ì´ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.")) {
                db.coaches = db.coaches.filter(c => c.id !== id);
                Object.keys(db.years).forEach(y => delete db.years[y][id]);
                // ë¡œìŠ¤í„° ì •ë¦¬
                Object.keys(db.rosters).forEach(k => {
                    db.rosters[k] = db.rosters[k].filter(cid => cid !== id);
                });
                
                saveData();
                renderMasterCoachList();
                renderAll();
            }
        }

        // === 3. [ëª¨ë‹¬ 2] ì›”ë³„ ê·¼ë¬´ì ê´€ë¦¬ ===
        function openRosterModal(monthIndex) {
            const year = document.getElementById('yearSelect').value;
            const currentRoster = db.rosters[`${year}-${monthIndex}`] || [];
            
            // ë§ˆìŠ¤í„° ë¦¬ìŠ¤íŠ¸ ì¤‘ í˜„ì¬ ì›”ì— ì—†ëŠ” ì½”ì¹˜ë§Œ í•„í„°ë§
            const availableCoaches = db.coaches.filter(c => !currentRoster.includes(c.id));
            const listEl = document.getElementById('rosterList');
            const titleEl = document.getElementById('rosterModalTitle');
            
            titleEl.innerText = `${monthIndex + 1}ì›” ê·¼ë¬´ì ì¶”ê°€`;
            
            if (availableCoaches.length === 0) {
                listEl.innerHTML = `<p class="text-slate-400 text-sm text-center py-4">ì¶”ê°€ ê°€ëŠ¥í•œ ì½”ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.<br>'ì½”ì¹˜ ëª…ë‹¨ ê´€ë¦¬'ì—ì„œ ì‹ ê·œ ì½”ì¹˜ë¥¼ ë“±ë¡í•˜ì„¸ìš”.</p>`;
            } else {
                listEl.innerHTML = availableCoaches.map(c => `
                    <button onclick="addToRoster(${monthIndex}, '${c.id}')" class="w-full text-left flex justify-between items-center p-3 hover:bg-indigo-50 rounded-xl border border-slate-100 mb-2 group transition-colors">
                        <span class="font-bold text-slate-700">${c.name}</span>
                        <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded group-hover:bg-indigo-200 font-medium">ì¶”ê°€í•˜ê¸° +</span>
                    </button>
                `).join('');
            }
            
            document.getElementById('rosterModal').classList.remove('hidden');
        }

        function addToRoster(monthIndex, coachId) {
            const year = document.getElementById('yearSelect').value;
            const key = `${year}-${monthIndex}`;
            if (!db.rosters[key]) db.rosters[key] = [];
            if (!db.rosters[key].includes(coachId)) db.rosters[key].push(coachId);
            
            // ë°ì´í„° ê³µê°„ í™•ë³´
            if (!db.years[year][coachId]) db.years[year][coachId] = Array(12).fill(0);

            saveData();
            renderAll();
            closeRosterModal();
        }

        function removeFromRoster(monthIndex, coachId) {
            const year = document.getElementById('yearSelect').value;
            const key = `${year}-${monthIndex}`;
            if (db.rosters[key]) {
                db.rosters[key] = db.rosters[key].filter(id => id !== coachId);
            }
            saveData();
            renderAll();
        }

        function closeRosterModal() {
            document.getElementById('rosterModal').classList.add('hidden');
        }

        // === 4. ë©”ì¸ ë Œë”ë§ & ê³„ì‚° ===
        function renderAll() {
            const container = document.getElementById('monthContainer');
            const year = document.getElementById('yearSelect').value;
            container.innerHTML = '';

            for (let i = 0; i < 12; i++) {
                container.innerHTML += createMonthCard(i, year);
            }
            for (let i = 0; i < 12; i++) {
                updateCardCalcs(i);
            }
            updateDashboard();
        }

        function createMonthCard(monthIndex, year) {
            const roster = db.rosters[`${year}-${monthIndex}`] || [];
            // ìœ íš¨í•œ ì½”ì¹˜ë§Œ ë§¤í•‘
            const activeCoaches = roster.map(id => db.coaches.find(c => c.id === id)).filter(c => c);

            const rows = activeCoaches.map(c => {
                const val = db.years[year]?.[c.id]?.[monthIndex] || 0;
                return `
                <div class="py-3 border-b border-slate-100 last:border-0">
                    <div class="flex justify-between items-center mb-1">
                        <div class="font-bold text-slate-700 text-sm">${c.name}</div>
                        <button onclick="removeFromRoster(${monthIndex}, '${c.id}')" class="text-[10px] text-slate-300 hover:text-red-500 border border-slate-100 hover:border-red-200 px-2 py-0.5 rounded transition-colors">ì´ë‹¬ ì œì™¸</button>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="relative flex-1">
                            <input type="tel" value="${val > 0 ? val.toLocaleString() : ''}" 
                                oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','); updateAmount(${monthIndex}, '${c.id}', this.value)"
                                class="w-full bg-slate-50 border border-slate-200 rounded-lg py-2 px-3 text-right font-bold text-slate-800 focus:ring-2 focus:ring-indigo-500 outline-none text-sm placeholder-slate-300" placeholder="0">
                            <span class="absolute left-2 top-2.5 text-[10px] text-slate-400 font-medium">ì§€ê¸‰ì•¡</span>
                        </div>
                        <div class="w-[40%] flex flex-col items-end text-right">
                            <div class="text-[10px] text-slate-500 mb-0.5">ì„¸ê¸ˆ(3.3%) <span id="tax-${monthIndex}-${c.id}" class="text-red-500 font-medium ml-1">0</span></div>
                            <div class="text-sm font-black text-indigo-700"><span class="text-[10px] text-indigo-300 mr-1 font-normal">ì°¨ì¸</span><span id="net-${monthIndex}-${c.id}">0</span></div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            return `
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden fade-in">
                <div class="bg-slate-50 px-5 py-3 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-lg font-black text-slate-800">${monthIndex + 1}ì›”</h3>
                    <button onclick="openRosterModal(${monthIndex})" class="text-xs bg-white border border-slate-200 text-indigo-600 font-bold px-3 py-1.5 rounded-lg hover:bg-indigo-50 shadow-sm">+ ê·¼ë¬´ì ì¶”ê°€</button>
                </div>
                <div class="px-5 py-2">${rows.length ? rows : '<div class="text-center py-6 text-xs text-slate-400">ê·¼ë¬´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>'}</div>
                <div class="bg-indigo-50/50 border-t border-indigo-100 px-5 py-4 mt-2">
                    <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-indigo-900 bg-indigo-100 px-2 py-1 rounded">ì›”ë§ í•©ê³„</span></div>
                    <div class="grid grid-cols-3 gap-2 text-center divide-x divide-indigo-200/50">
                        <div><div class="text-[10px] text-slate-500 mb-1">ì´ ì§€ê¸‰ì•¡</div><div id="foot-gross-${monthIndex}" class="text-sm font-bold text-slate-700">0</div></div>
                        <div><div class="text-[10px] text-slate-500 mb-1">ì´ ì›ì²œì„¸</div><div id="foot-tax-${monthIndex}" class="text-sm font-bold text-red-500">0</div></div>
                        <div><div class="text-[10px] text-indigo-500 font-bold mb-1">ì´ ì°¨ì¸ì§€ê¸‰ì•¡</div><div id="foot-net-${monthIndex}" class="text-base font-black text-indigo-700">0</div></div>
                    </div>
                </div>
            </div>`;
        }

        function updateAmount(monthIndex, coachId, value) {
            const year = document.getElementById('yearSelect').value;
            const num = parseInt(value.replace(/[^0-9]/g, '')) || 0;
            if (!db.years[year]) db.years[year] = {};
            if (!db.years[year][coachId]) db.years[year][coachId] = Array(12).fill(0);
            db.years[year][coachId][monthIndex] = num;
            saveData();
            updateCardCalcs(monthIndex);
            updateDashboard();
        }

        function updateCardCalcs(monthIndex) {
            const year = document.getElementById('yearSelect').value;
            const roster = db.rosters[`${year}-${monthIndex}`] || [];
            let mGross=0, mTax=0, mNet=0;

            roster.forEach(id => {
                const val = db.years[year]?.[id]?.[monthIndex] || 0;
                const tax = Math.floor(val * 0.033);
                const net = val - tax;

                const tEl = document.getElementById(`tax-${monthIndex}-${id}`);
                const nEl = document.getElementById(`net-${monthIndex}-${id}`);
                if(tEl) tEl.innerText = tax.toLocaleString();
                if(nEl) nEl.innerText = net.toLocaleString();

                mGross += val; mTax += tax; mNet += net;
            });

            const fG = document.getElementById(`foot-gross-${monthIndex}`);
            const fT = document.getElementById(`foot-tax-${monthIndex}`);
            const fN = document.getElementById(`foot-net-${monthIndex}`);
            if(fG) fG.innerText = mGross.toLocaleString();
            if(fT) fT.innerText = mTax.toLocaleString();
            if(fN) fN.innerText = mNet.toLocaleString();
        }

        function updateDashboard() {
            const year = document.getElementById('yearSelect').value;
            let yGross=0, yTax=0;
            // Roster ê¸°ì¤€ í•©ê³„
            for(let m=0; m<12; m++) {
                const roster = db.rosters[`${year}-${m}`] || [];
                roster.forEach(id => {
                    const val = db.years[year]?.[id]?.[m] || 0;
                    yGross += val;
                    yTax += Math.floor(val * 0.033);
                });
            }
            document.getElementById('dashGross').innerText = yGross.toLocaleString();
            document.getElementById('dashTax').innerText = yTax.toLocaleString();
            document.getElementById('dashNet').innerText = (yGross - yTax).toLocaleString() + 'ì›';
        }

        function setupYearSelect() {
            const select = document.getElementById('yearSelect');
            const years = Object.keys(db.years).sort();
            if (!years.includes(CURRENT_YEAR)) years.push(CURRENT_YEAR);
            select.innerHTML = years.map(y => `<option value="${y}" ${y === CURRENT_YEAR ? 'selected' : ''}>${y}ë…„ ì¥ë¶€</option>`).join('');
        }
        function changeYear() { renderAll(); }

        // === 5. ì„¸ë¬´ì‚¬ ì „ì†¡ (ì¸ì ì‚¬í•­ í¬í•¨) ===
        function sendEmailReport() {
            const year = document.getElementById('yearSelect').value;
            
            // ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (Roster ê¸°ì¤€)
            let hasData = false;
            for(let m=0; m<12; m++) {
                const roster = db.rosters[`${year}-${m}`] || [];
                if (roster.some(id => (db.years[year]?.[id]?.[m] || 0) > 0)) hasData = true;
            }
            if (!hasData) { alert("ì „ì†¡í•  ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

            // í™œì„± ì½”ì¹˜ ëª©ë¡ ì¶”ì¶œ
            const activeIds = new Set();
            for(let m=0; m<12; m++) {
                (db.rosters[`${year}-${m}`] || []).forEach(id => {
                    if ((db.years[year]?.[id]?.[m] || 0) > 0) activeIds.add(id);
                });
            }
            const activeCoaches = db.coaches.filter(c => activeIds.has(c.id));

            let body = `ì„¸ë¬´ì‚¬ë‹˜, ì•ˆë…•í•˜ì„¸ìš”.\n${year}ë…„ë„ ì²´ìœ¡ê´€ ì¸ê±´ë¹„ ì‹ ê³ ìë£Œ ì†¡ë¶€ë“œë¦½ë‹ˆë‹¤.\n\n`;

            // [ì„¹ì…˜ 0] ì¸ì ì‚¬í•­ (ê°€ì¥ ì¤‘ìš”)
            body += `â–  1. ì½”ì¹˜ ì¸ì ì‚¬í•­ (ì„¸ë¬´ì‹ ê³ ìš©)\n`;
            body += `===================================\n`;
            activeCoaches.forEach(c => {
                body += `- ì´ë¦„: ${c.name}  |  ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸: ${c.jumin || '(ë¯¸ì…ë ¥)'}\n`;
            });
            body += `===================================\n\n`;

            // [ì„¹ì…˜ 1] ì—°ê°„ í•©ê³„
            let grandTotal = 0;
            body += `â–  2. ê°œì¸ë³„ ì—°ê°„ ì§€ê¸‰ ì´ì•¡\n`;
            activeCoaches.forEach(c => {
                let cTotal = 0, cTax = 0;
                for(let m=0; m<12; m++) {
                    if((db.rosters[`${year}-${m}`]||[]).includes(c.id)) {
                        const v = db.years[year]?.[c.id]?.[m] || 0;
                        cTotal += v; cTax += Math.floor(v*0.033);
                    }
                }
                body += `[${c.name}] ì§€ê¸‰: ${cTotal.toLocaleString()}ì› (ì„¸ê¸ˆ: ${cTax.toLocaleString()}ì›)\n`;
                grandTotal += cTotal;
            });
            body += `>> ì—°ê°„ ì´ ì§€ê¸‰í•©ê³„: ${grandTotal.toLocaleString()}ì›\n\n`;

            // [ì„¹ì…˜ 2] ì›”ë³„ ìƒì„¸
            body += `â–  3. ì›”ë³„ ê¸‰ì—¬ ìƒì„¸ ë‚´ì—­\n`;
            for(let i=0; i<12; i++) {
                const roster = db.rosters[`${year}-${i}`] || [];
                const paid = roster.filter(id => (db.years[year]?.[id]?.[i]||0) > 0);
                if(paid.length > 0) {
                    body += `\n[${i+1}ì›”]\n`;
                    let mG=0, mT=0, mN=0;
                    paid.forEach(id => {
                        const c = db.coaches.find(x => x.id === id);
                        const v = db.years[year][id][i];
                        const t = Math.floor(v*0.033);
                        const n = v-t;
                        body += `- ${c.name}: ì§€ê¸‰ ${v.toLocaleString()} / ì„¸ê¸ˆ ${t.toLocaleString()} / ì°¨ì¸ ${n.toLocaleString()}\n`;
                        mG+=v; mT+=t; mN+=n;
                    });
                    body += `* ${i+1}ì›” í•©ê³„: ì§€ê¸‰ ${mG.toLocaleString()} / ì„¸ê¸ˆ ${mT.toLocaleString()} / ì°¨ì¸ ${mN.toLocaleString()}\n`;
                }
            }

            const subject = encodeURIComponent(`[ê¸‰ì—¬ì‹ ê³ ] ${year}ë…„ë„ ì²´ìœ¡ê´€ ì¸ê±´ë¹„ ëª…ì„¸ì„œ`);
            window.location.href = `mailto:?subject=${subject}&body=${encodeURIComponent(body)}`;
        }
    </script>
</body>
</html>

```